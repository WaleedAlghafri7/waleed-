<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineStream</title>
    <link rel="icon" type="image/png" href="CineStream web.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1421;
            --panel: #151b2b;
            --muted: #2a324a;
            --text: #e8ecf1;
            --brand: #ffd54a;
            --accent: #35d07f;
            --danger: #ff5c5c;
        }
        body { background:linear-gradient(180deg, #0b1020, #131a2e); color:var(--text); font-family: Inter, system-ui, Arial, sans-serif; margin:0; }
        .admin-container { max-width:1200px; margin:32px auto; background:rgba(21,27,43,0.8); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.06); border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,0.45); padding:28px; }
        .admin-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:22px; }
        .admin-header h1 { margin:0; font-size:28px; letter-spacing:0.5px; color:var(--brand); text-shadow:0 0 20px rgba(255,213,74,0.2); }
        .tabs { display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
        .tab-btn { padding:10px 16px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; background:linear-gradient(180deg, #1a2238, #151b2b); color:#f2f2f2; cursor:pointer; transition:.2s; }
        .tab-btn:hover { transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,0.25); }
        .tab-btn.active { background:linear-gradient(180deg, #ffd54a, #f7b733); color:#111; border-color:rgba(0,0,0,0.12); }
        .section { display:none; animation: fadeIn .2s ease; }
        .section.active { display:block; }
        .add-btn { background:linear-gradient(180deg, #35d07f, #1fb36a); color:#0a121f; border:none; border-radius:12px; padding:10px 16px; cursor:pointer; margin-bottom:12px; font-weight:700; letter-spacing:0.3px; box-shadow: 0 8px 20px rgba(53,208,127,0.25); }
        .data-table { width:100%; border-collapse:separate; border-spacing:0 8px; }
        .data-table th { background:transparent; color:#9fb3c8; font-weight:700; font-size:13px; text-transform: uppercase; letter-spacing:0.8px; padding:6px 10px; }
        .data-table td { background:linear-gradient(180deg, #161d30, #131a2a); border:1px solid rgba(255,255,255,0.04); padding:12px 10px; }
        .data-table tr td:first-child { border-top-left-radius:12px; border-bottom-left-radius:12px; }
        .data-table tr td:last-child { border-top-right-radius:12px; border-bottom-right-radius:12px; }
        .data-table .img-cell { width:110px; }
        .data-table .img-cell img { width:100px; height:100px; object-fit:cover; border-radius:0; background:#0f1524; border:1px solid rgba(255,255,255,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.35); }
        .action-btn { background:linear-gradient(180deg, #ffd54a, #f7b733); color:#111; border:none; border-radius:10px; padding:8px 12px; margin-right:6px; cursor:pointer; font-weight:700; letter-spacing:0.3px; box-shadow:0 6px 18px rgba(247,183,51,0.25); }
        .action-btn.delete { background:linear-gradient(180deg, #ff6b6b, #e05252); color:#fff; box-shadow:0 6px 18px rgba(255,107,107,0.25); }
        #saveNotification { display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:2000; padding:12px 18px; background:#1a2238; color:#fff; border:1px solid rgba(255,255,255,0.08); border-radius:12px; font-weight:700; font-size:14px; transition:opacity .25s; opacity:0; box-shadow:0 10px 30px rgba(0,0,0,0.35); }
        #slidesCounter { color:var(--brand); font-weight:700; font-size:14px; margin-left:8px; letter-spacing:0.4px; }
        .slide-checkbox { width:22px; height:22px; accent-color:var(--brand); cursor:pointer; }
        /* Slides grid cards */
        .slides-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; }
        .slide-card { background:linear-gradient(180deg, #161d30, #131a2a); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:10px; text-align:center; cursor:pointer; transition:.15s ease; }
        .slide-card:hover { transform: translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.25); }
        .slide-card.selected { background:#27ae60; border-color:#27ae60; color:#0a121f; }
        .slide-card img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:6px; display:block; background:#0f1524; }
        .slide-card .title { margin-top:8px; font-weight:700; font-size:13px; line-height:1.3; }
        .slide-card .type { margin-top:4px; font-size:12px; opacity:.8; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin Panel</h1>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="movies">Movies</button>
            <button class="tab-btn" data-tab="series">Series</button>
            <button class="tab-btn" data-tab="slides">Slides</button>
        </div>

        <div id="movies" class="section active">
            <button class="add-btn" onclick="openModal('movie')"><i class="fas fa-plus"></i> Add Movie</button>
            <table class="data-table" id="moviesTable">
                <thead>
                    <tr>
                        <th class="img-cell">Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Rating</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="series" class="section">
            <button class="add-btn" onclick="openModal('series')"><i class="fas fa-plus"></i> Add Series</button>
            <table class="data-table" id="seriesTable">
                <thead>
                    <tr>
                        <th class="img-cell">Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Status</th>
                        <th>Rating</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="slides" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <h3 style="margin:0;color:#ffd700;">Slides</h3>
                    <span id="slidesCounter"></span>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button type="button" id="slidesClearBtn" class="add-btn" style="background:#e74c3c;color:#fff;">Deselect All</button>
                    <button type="button" id="slidesSaveBtn" class="add-btn">Save changes</button>
                </div>
            </div>
            <table class="data-table" id="slidesAllTable">
                <thead>
                    <tr>
                        <th class="img-cell">Image</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Year</th>
                        <th>Rating</th>
                        <th>Featured</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div style="margin-top:14px;">
                <h3 style="margin:0 0 8px 0;color:#ffd700;">Current Slides</h3>
                <table class="data-table" id="slidesCurrentTable">
                    <thead>
                        <tr>
                            <th class="img-cell">Image</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Backdrop</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="saveNotification"></div>

    <script src="./admin.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CineStream</title>
    <link rel="icon" type="image/png" href="CineStream web.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #12161f;
            font-family: 'Poppins', sans-serif;
            color: #f1f1f1;
            margin: 0;
            padding: 0;
        }

        .admin-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #1c2130;
            border-radius: 18px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
            padding: 36px;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffd700;
        }

        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 26px;
            border: none;
            border-radius: 25px;
            background: #2a2f41;
            color: #fff;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s ease;
        }

        .tab-btn.active {
            background: #ffd700;
            color: #1c2130;
            font-weight: 600;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 32px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #2f3447;
            text-align: left;
        }

        .data-table th {
            background: #23283a;
            color: #ffd700;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #2a2f41;
        }

        .action-btn {
            background: #ffd700;
            color: #1c2130;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            margin-right: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s ease;
        }

        .action-btn.delete {
            background: #e74c3c;
            color: #fff;
        }

        .add-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 10px 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 18px;
            transition: 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1f2433;
            border-radius: 16px;
            padding: 40px 36px;
            /* Bigger padding */
            max-width: 5000px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 28px;
            color: #ffd700;
            font-size: 2.2rem;
            /* Bigger title */
        }

        .form-row {
            display: flex;
            gap: 32px;
            /* Bigger gap */
            margin-bottom: 28px;
            /* Bigger margin */
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            display: flex;
            margin-top: 20px;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.25rem;
            /* Bigger label */
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 18px 16px;
            /* Bigger input */
            border-radius: 14px;
            border: 1.5px solid #2e3347;
            background: #2a2f41;
            color: #fff;
            font-size: 1.25rem;
            /* Bigger font */
        }

        .form-group textarea {
            min-height: 140px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 28px;
        }

        .modal-actions button {
            padding: 16px 36px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
        }

        .modal-actions .save-btn {
            background: #27ae60;
            color: #fff;
        }

        .modal-actions .cancel-btn {
            background: #e74c3c;
            color: #fff;
        }

        .data-table .img-cell {
            width: 80px;
            padding: 6px 4px;
        }

        .data-table .img-cell img {
            width: 120px;
            height: auto;
            object-fit: cover;
            border-radius: 8px;
            background: #181c24;
            border: 1px solid #2e3347;
            display: block;
        }

        /* Make season/episode blocks bigger in modal */
        .season-block {
            background: #23283a;
            padding: 18px 18px !important;
            margin-bottom: 18px !important;
            border-radius: 12px !important;
            font-size: 1.15rem;
        }

        .season-block strong {
            font-size: 1.2rem;
        }

        .season-block button {
            font-size: 1.1rem !important;
            padding: 6px 16px !important;
        }

        .episode-block {
            background: #2e3347;
            padding: 12px 12px !important;
            margin-bottom: 10px !important;
            border-radius: 10px !important;
            font-size: 1.1rem;
        }

        .episode-block input {
            font-size: 1.1rem !important;
            padding: 10px 10px !important;
            margin-right: 10px !important;
        }

        .episode-block button {
            font-size: 1.1rem !important;
            padding: 6px 16px !important;
        }

        /* Add style for episode rating input */
        .episode-block .episode-rating-group {
            display: flex;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
            gap: 8px;
        }

        .episode-block .episode-rating-group label {
            font-size: 1.05rem;
            color: #ffd700;
            margin-bottom: 0;
            font-weight: 600;
        }

        .episode-block .episode-rating-group input[type="number"] {
            width: 80px;
            padding: 8px 10px !important;
            font-size: 1.1rem !important;
            border-radius: 8px;
            border: 1px solid #ffd700;
            background: #23283a;
            color: #fff;
        }

        /* Scrollbar Styles */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #2e3347;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1f2433;
        }

        @media (max-width: 700px) {
            .admin-container {
                padding: 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 16px;
                margin-bottom: 16px;
            }

            .data-table .img-cell {
                width: 40px;
            }

            .data-table .img-cell img {
                width: 40px;
                height: 60px;
            }

            .modal-content {
                padding: 16px 6px;
            }

            .modal-content h2 {
                font-size: 1.3rem;
            }

            .form-group label {
                font-size: 1rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 1rem;
                padding: 10px 8px;
            }

            .modal-actions button {
                font-size: 1rem;
                padding: 10px 18px;
            }

            .season-block,
            .episode-block {
                font-size: 1rem;
                padding: 8px 6px !important;
            }

            .episode-block .episode-rating-group input[type="number"] {
                width: 60px;
                font-size: 1rem !important;
            }
        }
        /* Slides counter style */
        #slidesCounter {
            color: #ffd700;
            font-weight: 600;
            font-size: 1.1rem;
            margin-left: 12px;
        }
        /* Slides grid cards */
        .slides-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; }
        .slide-card { background:linear-gradient(180deg, #161d30, #131a2a); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:10px; text-align:center; cursor:pointer; transition:.15s ease; }
        .slide-card:hover { transform: translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.25); }
        .slide-card.selected { background:#27ae60; border-color:#27ae60; color:#0a121f; }
        .slide-card img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:6px; display:block; background:#0f1524; }
        .slide-card .title { margin-top:8px; font-weight:700; font-size:13px; line-height:1.3; }
        .slide-card .type { margin-top:4px; font-size:12px; opacity:.8; }
    </style>

</head>

<body>

    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>
            <form id="itemForm">
                <input type="hidden" id="itemType">
                <input type="hidden" id="itemId">
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn" id="saveBtn">Save</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label>Genre</label>
                        <div id="genreOptions" style="display:flex;flex-wrap:wrap;gap:8px;overflow:auto;border:1px solid rgba(255,255,255,0.12);padding:8px;border-radius:8px;"></div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="genreCustomInput" placeholder="Add custom genre" style="flex:1;">
                            <button type="button" id="genreAddBtn" class="action-btn" style="padding:8px 14px;">Add</button>
                            <button type="button" id="genreClearBtn" class="action-btn delete" style="padding:8px 14px;">Clear</button>
                        </div>
                        <input type="hidden" id="genre">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="date" id="year" required>
                    </div>
                    <div class="form-group">
                        <label for="rating">Rating</label>
                        <input type="number" id="rating" step="0.1" min="0" max="10" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="duration">Duration</label>
                        <input type="text" id="duration" required>
                    </div>
                    <div class="form-group" id="statusGroup" style="display:none;">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="">Select status</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <!-- New row for language, country, ageRating -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="language">Language</label>
                        <input type="text" id="language" placeholder="e.g. English, Arabic">
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" placeholder="e.g. USA, Egypt">
                    </div>
                    <div class="form-group">
                        <label for="ageRating">Age Rating</label>
                        <select id="ageRating">
                            <option value="">Select age rating</option>
                            <option value="G">G (General Audiences)</option>
                            <option value="PG">PG (Parental Guidance Suggested)</option>
                            <option value="PG-13">PG-13 (Parents Strongly Cautioned)</option>
                            <option value="R">R (Restricted)</option>
                            <option value="NC-17">NC-17 (Adults Only)</option>
                            <option value="TV-Y">TV-Y (All Children)</option>
                            <option value="TV-Y7">TV-Y7 (Directed to Older Children)</option>
                            <option value="TV-G">TV-G (General Audience)</option>
                            <option value="TV-PG">TV-PG (Parental Guidance Suggested)</option>
                            <option value="TV-14">TV-14 (Parents Strongly Cautioned)</option>
                            <option value="TV-MA">TV-MA (Mature Audience Only)</option>
                        </select>
                    </div>
                </div>
                <div id="editForm"></div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="image">Image URL</label>
                        <input type="url" id="image" required>
                    </div>
                    <div class="form-group">
                        <label for="backdrop">Backdrop URL</label>
                        <input type="url" id="backdrop" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="form-group" id="seasonsGroup" style="display:none;">
                    <label>Seasons & Episodes</label>
                    <div id="seasonsList"></div>
                    <button type="button" class="add-btn"
                        style="margin:16px 0 0 0; padding:12px 28px; font-size:1.15rem;" onclick="addSeason()"><i
                            class="fas fa-plus"></i> Add Season</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="saveNotification"
        style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);z-index:2000;padding:16px 32px;background:#23283a;color:#fff;border-radius:10px;font-weight:600;box-shadow:0 2px 12px rgba(0,0,0,0.18);font-size:1.1rem;transition:opacity 0.3s;opacity:0;">
    </div>
    <script type="module">
        async function loadForm(type, item) {
            const res = await fetch("/static/fields_config.json"); // تأكد أن الملف هنا أو غير المسار
            const config = await res.json();

            const container = document.getElementById("editForm");
            container.innerHTML = "";

            const fields = config[type];
            fields.forEach(field => {
                const value = item[field] || "";
                const input = document.createElement("input");
                input.name = field;
                input.value = value;
                input.placeholder = field;
                container.appendChild(input);
                container.appendChild(document.createElement("br"));
            });
        }

        let data = { movies: [], series: [] };

        // Fetch data: try Flask API then fallback to local data.json, with detailed error info
        async function fetchData() {
            let apiErr = null;
            try {
                const apiUrl = 'http://127.0.0.1:5000/data?t=' + Date.now();
                const res = await fetch(apiUrl);
                if (!res.ok) {
                    let body = '';
                    try { body = await res.text(); } catch (e) { body = String(e); }
                    throw new Error(`API failed: status=${res.status} ${res.statusText} body=${body}`);
                }
                data = await res.json();
            } catch (err1) {
                apiErr = err1;
                try {
                    const fileUrl = 'data.json?t=' + Date.now();
                    const res2 = await fetch(fileUrl);
                    if (!res2.ok) {
                        let body2 = '';
                        try { body2 = await res2.text(); } catch (e) { body2 = String(e); }
                        throw new Error(`data.json failed: status=${res2.status} ${res2.statusText} body=${body2}`);
                    }
                    data = await res2.json();
                } catch (err2) {
                    const online = (typeof navigator !== 'undefined' && 'onLine' in navigator) ? navigator.onLine : 'unknown';
                    const details = [
                        `API URL: http://127.0.0.1:5000/data`,
                        `Location: ${typeof location !== 'undefined' && location.href ? location.href : 'n/a'}`,
                        `Online: ${online}`,
                        `API Error: ${apiErr && apiErr.message ? apiErr.message : apiErr}`,
                        `File Error: ${err2 && err2.message ? err2.message : err2}`
                    ].join('\n');
                    showSaveNotification(false, 'فشل في تحميل البيانات!');
                    alert('فشل تحميل البيانات!\n\nتفاصيل:\n' + details);
                    return;
                }
            }

            // Ensure defaults
            data.movies = data.movies || [];
            data.series = data.series || [];
            data.featured = data.featured || [];

            renderTables();
            populateGenreOptions();
        }
        fetchData();

        // Render tables
        function renderTables() {
            function toEpoch(it) {
                try {
                    if (typeof it?.id === 'number' && it.id > 1e11) return it.id;
                    if (it?.releaseDate) {
                        const t = Date.parse(String(it.releaseDate));
                        if (!isNaN(t)) return t;
                    }
                    if (it?.year) {
                        const y = String(it.year).slice(0,4);
                        if (/^\d{4}$/.test(y)) return Date.parse(y + '-01-01');
                    }
                } catch (e) {}
                return 0;
            }
            const sortNewest = (a, b) => toEpoch(b) - toEpoch(a);
            // Movies
            const moviesTbody = document.querySelector('#moviesTable tbody');
            moviesTbody.innerHTML = '';
            [...data.movies].sort(sortNewest).forEach(movie => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="img-cell">
                        <img src="${movie.image ? movie.image : ''}" alt="Movie Image" onerror="this.onerror=null; this.src='13434998.png';";">
                    </td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year ? (typeof movie.year === 'string' ? movie.year.slice(0,4) : movie.year) : ''}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.duration}</td>
                    <td>
                        <button class="action-btn" style="font-size:1.15rem;padding:12px 28px;" onclick="openModal('movie', ${movie.id})">Edit</button>
                        <button class="action-btn delete" style="font-size:1.15rem;padding:12px 28px;" onclick="deleteItem('movie', ${movie.id})">Delete</button>
                    </td>
                `;
                moviesTbody.appendChild(tr);
            });
            // Series
            const seriesTbody = document.querySelector('#seriesTable tbody');
            seriesTbody.innerHTML = '';
            [...data.series].sort(sortNewest).forEach(series => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="img-cell">
                        <img src="${series.image ? series.image : ''}" alt="Series Image" onerror="this.onerror=null; this.src='13434998.png';";">
                    </td>
                    <td>${series.title}</td>
                    <td>${series.genre}</td>
                    <td>${series.year ? (typeof series.year === 'string' ? series.year.slice(0,4) : series.year) : ''}</td>
                    <td>${series.status || ''}</td>
                    <td>${series.rating}</td>
                    <td>${series.duration}</td>
                    <td>
                        <button class="action-btn" style="font-size:1.15rem;padding:12px 28px;" onclick="openModal('series', ${series.id})">Edit</button>
                        <button class="action-btn delete" style="font-size:1.15rem;padding:12px 28px;" onclick="deleteItem('series', ${series.id})">Delete</button>
                    </td>
                `;
                seriesTbody.appendChild(tr);
            });

            // Slides editor (all items)
            const slidesAllTbody = document.querySelector('#slidesAllTable tbody');
            if (slidesAllTbody) {
                slidesAllTbody.innerHTML = '';
                const rows = [];
                (data.movies || []).forEach(m => rows.push({ ...m, _type: 'movie' }));
                (data.series || []).forEach(s => rows.push({ ...s, _type: 'series' }));
                rows.sort(sortNewest);
                const featuredSet = new Set((data.featured || []).map(f => `${f.type}:${f.id}`));
                rows.forEach(item => {
                    const checked = featuredSet.has(`${item._type}:${item.id}`) || !!item.inSlides;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="img-cell">
                            <img src="${item.image ? item.image : ''}" alt="Image" onerror="this.onerror=null; this.src='13434998.png';">
                        </td>
                        <td>${item.title}</td>
                        <td>${item._type}</td>
                        <td>${item.year ? (typeof item.year === 'string' ? item.year.slice(0,4) : item.year) : ''}</td>
                        <td>${item.rating}</td>
                        <td>
                            <input type="checkbox" class="slides-bulk" data-type="${item._type}" data-id="${item.id}" ${checked ? 'checked' : ''} style="width:28px; height:28px; accent-color:#ffd700;">
                        </td>
                    `;
                    slidesAllTbody.appendChild(tr);
                });
                // Update slides counter after rendering
                updateSlidesCounter();
                // Enforce max 6 checked
                enforceSlidesCheckboxLimit();
            }

            // Current Slides table
            const slidesCurrentTbody = document.querySelector('#slidesCurrentTable tbody');
            if (slidesCurrentTbody) {
                slidesCurrentTbody.innerHTML = '';
                [...(data.featured || [])].sort(sortNewest).forEach(f => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="img-cell"><img src="${f.image ? f.image : ''}" alt="Image" onerror="this.onerror=null; this.src='13434998.png';"></td>
                        <td>${f.title || '-'}</td>
                        <td>${f.type || '-'}</td>
                        <td style="max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f.backdrop || '-'}</td>
                    `;
                    slidesCurrentTbody.appendChild(tr);
                });
            }
        }

        // Slides counter and limit logic
        function updateSlidesCounter() {
            const checkboxes = Array.from(document.querySelectorAll('.slides-bulk'));
            const checkedCount = checkboxes.filter(cb => cb.checked).length;
            const total = checkboxes.length;
            const counter = document.getElementById('slidesCounter');
            if (counter) {
                counter.textContent = `${checkedCount} Of origin 6`;
            }
        }

        function enforceSlidesCheckboxLimit() {
            const checkboxes = Array.from(document.querySelectorAll('.slides-bulk'));
            function update() {
                const checked = checkboxes.filter(cb => cb.checked);
                if (checked.length >= 6) {
                    checkboxes.forEach(cb => {
                        if (!cb.checked) cb.disabled = true;
                    });
                } else {
                    checkboxes.forEach(cb => cb.disabled = false);
                }
                updateSlidesCounter();
            }
            checkboxes.forEach(cb => {
                cb.removeEventListener('change', cb._slidesLimitHandler || (()=>{}));
                cb._slidesLimitHandler = update;
                cb.addEventListener('change', update);
            });
            // Initial state
            update();
        }

        // Slides bulk save
        document.addEventListener('click', async (e) => {
            if (e.target && e.target.id === 'slidesSaveBtn') {
                const toggles = Array.from(document.querySelectorAll('.slides-bulk'));
                const updates = toggles.map(cb => ({
                    type: cb.getAttribute('data-type'),
                    id: Number(cb.getAttribute('data-id')),
                    inSlides: !!cb.checked
                }));
                // Only allow up to 6 checked
                const checkedCount = toggles.filter(cb => cb.checked).length;
                if (checkedCount > 6) {
                    showSaveNotification(false, 'مسموح فقط 6 عناصر في السلايدر');
                    return;
                }
                // Send sequentially to ensure backend consistency
                try {
                    for (const u of updates) {
                        await fetch('http://127.0.0.1:5000/save_data', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'feature', ...u })
                        });
                    }
                    await fetchData();
                    showSaveNotification(true, 'تم حفظ تغييرات السلايدر');
                } catch (err) {
                    showSaveNotification(false, 'تعذر حفظ تغييرات السلايدر');
                }
            }
        });

        function uniqGenresFromData() {
            const set = new Set();
            const add = (g) => {
                if (!g) return;
                if (Array.isArray(g)) g.forEach(x => String(x).split(',').forEach(y => set.add(y.trim())));
                else String(g).split(',').forEach(y => set.add(y.trim()));
            };
            (data.movies || []).forEach(m => add(m.genre));
            (data.series || []).forEach(s => add(s.genre));
            return Array.from(set).filter(x => x).sort((a,b) => a.localeCompare(b));
        }

        function populateGenreOptions() {
            const container = document.getElementById('genreOptions');
            if (!container) return;
            container.innerHTML = '';
            const genres = uniqGenresFromData();
            genres.forEach(g => {
                const label = document.createElement('label');
                label.style = 'display:inline-flex;align-items:center;gap:6px;background:#2e3347;padding:6px 10px;border-radius:6px;cursor:pointer;';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = g;
                cb.addEventListener('change', () => {
                    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                    document.getElementById('genre').value = selected.join(', ');
                });
                const span = document.createElement('span');
                span.textContent = g;
                label.appendChild(cb);
                label.appendChild(span);
                container.appendChild(label);
            });

            // Wire the custom add button
            const addBtn = document.getElementById('genreAddBtn');
            const input = document.getElementById('genreCustomInput');
            if (addBtn && input) {
                const addCustom = () => {
                    const val = (input.value || '').trim();
                    if (!val) return;
                    // Prevent duplicates (case-insensitive)
                    const exists = Array.from(container.querySelectorAll('input[type="checkbox"]')).some(cb => cb.value.toLowerCase() === val.toLowerCase());
                    if (!exists) {
                        const label = document.createElement('label');
                        label.style = 'display:inline-flex;align-items:center;gap:6px;background:#2e3347;padding:6px 10px;border-radius:6px;cursor:pointer;';
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.value = val;
                        cb.checked = true;
                        cb.addEventListener('change', () => {
                            const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                            document.getElementById('genre').value = selected.join(', ');
                        });
                        const span = document.createElement('span');
                        span.textContent = val;
                        label.appendChild(cb);
                        label.appendChild(span);
                        container.appendChild(label);
                    } else {
                        // If exists, just check it
                        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb.value.toLowerCase() === val.toLowerCase()) cb.checked = true;
                        });
                    }
                    // Update hidden field and clear input
                    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                    document.getElementById('genre').value = selected.join(', ');
                    input.value = '';
                    input.focus();
                };
                addBtn.onclick = addCustom;
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustom();
                    }
                });
            }

            // Wire clear button
            const clearBtn = document.getElementById('genreClearBtn');
            if (clearBtn) {
                clearBtn.onclick = () => {
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.getElementById('genre').value = '';
                };
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(type + '-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }


        // Tabs logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Show/hide seasons field for series
        function toggleSeasonsField(type) {
            document.getElementById('seasonsGroup').style.display = (type === 'series') ? 'block' : 'none';
        }

        // Add season
        window.addSeason = function (seasonNumberValue = null) {
            const seasonsList = document.getElementById('seasonsList');
            const seasonIdx = seasonsList.children.length + 1;
            const seasonDiv = document.createElement('div');
            seasonDiv.className = 'season-block';
            seasonDiv.style = 'background:#23283a;padding:18px 18px;margin-bottom:18px;border-radius:12px;';
            // إضافة حقل season_number (نصي أو رقمي)
            seasonDiv.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
                    <strong>Season</strong>
                    <input type="text" class="season-number-input" placeholder="season_number" style="width:110px;padding:8px 10px;border-radius:8px;border:1px solid #ffd700;background:#23283a;color:#fff;" value="${seasonNumberValue !== null && seasonNumberValue !== undefined ? seasonNumberValue : seasonIdx}">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="margin-left:auto;background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Delete</button>
                </div>
                <div style="margin-top:12px;">
                    <label style="font-size:1.1rem;">Episodes:</label>
                    <div class="episodes-list"></div>
                    <button type="button" onclick="addEpisode(this)" style="margin-top:10px;background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Add Episode</button>
                </div>
            `;
            seasonsList.appendChild(seasonDiv);
        }

        // Add episode
        window.addEpisode = function (btn) {
            const episodesList = btn.parentElement.querySelector('.episodes-list');
            // رقم الحلقة يتضاعف كل خانة جديدة
            let epIdx = episodesList.children.length;
            let episodeNumber = 1;
            if (epIdx > 0) {
                // Get the last episode's number and double it
                const lastEp = episodesList.lastElementChild;
                const lastNumInput = lastEp.querySelector('input.episode-number');
                let lastNum = 1;
                if (lastNumInput && lastNumInput.value !== undefined && lastNumInput.value !== null && lastNumInput.value !== '') {
                    lastNum = Number(lastNumInput.value);
                    if (isNaN(lastNum)) lastNum = 1;
                }
                episodeNumber = lastNum + 1;
            }
            const epDiv = document.createElement('div');
            epDiv.className = 'episode-block';
            epDiv.style = 'background:#2e3347;padding:12px 12px;margin-bottom:10px;border-radius:10px;';
            epDiv.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <label style="font-weight:bold;">Episode #</label>
                    <input type="number" class="episode-number" min="0" step="0.1" style="width:90px;padding:8px 10px;border-radius:8px;border:1px solid #ffd700;background:#23283a;color:#fff;" value="${episodeNumber}">
                    <label style="margin-left:16px;display:flex;align-items:center;gap:4px;">
                        <input type="checkbox" class="special-episode-checkbox" style="width:18px;height:18px;margin-left:4px;">
                        <span style="font-size:1rem;">Special</span>
                    </label>
                </div>
                <input type="text" placeholder="Episode Title" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="text" placeholder="Description" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="url" placeholder="Image URL" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="date" placeholder="Added Date" class="episode-added-date" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <div class="episode-rating-group">
                    <label>Rating</label>
                    <input type="number" placeholder="Rating" min="0" max="10" step="0.1" style="margin-right:10px;">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Delete</button>
            `;
            // Auto-fill added date based on previous episode (+7 days) or today
            const prev = episodesList.lastElementChild;
            const dateInput = epDiv.querySelector('.episode-added-date');
            let nextDateStr = '';
            if (prev) {
                const prevDateInput = prev.querySelector('.episode-added-date');
                const prevVal = prevDateInput && prevDateInput.value ? prevDateInput.value : '';
                if (/^\d{4}-\d{2}-\d{2}$/.test(prevVal)) {
                    const d = new Date(prevVal + 'T00:00:00Z');
                    if (!isNaN(d.getTime())) {
                        d.setUTCDate(d.getUTCDate() + 7);
                        const y = d.getUTCFullYear();
                        const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                        const day = String(d.getUTCDate()).padStart(2, '0');
                        nextDateStr = `${y}-${m}-${day}`;
                    }
                }
            }
            if (!nextDateStr) {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                nextDateStr = `${y}-${m}-${day}`;
            }
            if (dateInput) dateInput.value = nextDateStr;
            episodesList.appendChild(epDiv);
        }

        // Override openModal to load seasons/episodes
        window.openModal = function (type, id = null) {
            document.getElementById('itemModal').classList.add('active');
            document.getElementById('itemForm').reset();
            document.getElementById('itemType').value = type;
            document.getElementById('itemId').value = id || '';
            document.getElementById('modalTitle').textContent = id ? 'Edit ' + (type === 'movie' ? 'Movie' : 'Series') : 'Add ' + (type === 'movie' ? 'Movie' : 'Series');
            document.getElementById('statusGroup').style.display = (type === 'series') ? 'block' : 'none';
            toggleSeasonsField(type);
            // Clear seasons
            document.getElementById('seasonsList').innerHTML = '';
            // Fill language, country, ageRating if editing
            if (id) {
                const item = (type === 'movie' ? data.movies : data.series).find(i => i.id === id);
                if (item) {
                    document.getElementById('title').value = item.title;
                    // اضبط خيارات الأنواع المحددة
                    (function(){
                        const container = document.getElementById('genreOptions');
                        const selected = Array.isArray(item.genre) ? item.genre : String(item.genre || '').split(',').map(x=>x.trim()).filter(Boolean);
                        // تأكد أن الخيارات موجودة، ثم علم المختار
                        populateGenreOptions();
                        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            cb.checked = selected.includes(cb.value);
                        });
                        document.getElementById('genre').value = selected.join(', ');
                    })();
                    // اضبط حقل التاريخ مفضلاً releaseDate إن وجد، وإلا فحوّل السنة إلى YYYY-01-01
                    (function(){
                        const dateInput = document.getElementById('year');
                        if (!dateInput) return;
                        const raw = item.releaseDate || item.year;
                        if (!raw) { dateInput.value = ''; return; }
                        const s = String(raw).trim();
                        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                            dateInput.value = s.slice(0,10);
                        } else if (/^\d{4}/.test(s)) {
                            dateInput.value = `${s.slice(0,4)}-01-01`;
                        } else {
                            dateInput.value = '';
                        }
                    })();
                    document.getElementById('rating').value = item.rating;
                    document.getElementById('duration').value = item.duration;
                    document.getElementById('image').value = item.image;
                    document.getElementById('backdrop').value = item.backdrop;
                    document.getElementById('description').value = item.description;
                    document.getElementById('language').value = item.language || '';
                    document.getElementById('country').value = item.country || '';
                    document.getElementById('ageRating').value = item.ageRating || '';
                    if (type === 'series') {
                        document.getElementById('status').value = item.status || '';
                        // Load seasons/episodes
                        if (item.seasons && Array.isArray(item.seasons)) {
                            item.seasons.forEach(season => {
                                // Check if this is a specials season
                                let isSpecials = false;
                                if (season.season_number === 'specials' || season.season_number === 'Specials' || season.season_number === 0 || season.name === 'Specials') {
                                    isSpecials = true;
                                }
                                // Add a season block, passing the real season_number (even if string)
                                window.addSeason(season.season_number !== undefined ? season.season_number : '');
                                const lastSeason = document.getElementById('seasonsList').lastElementChild;
                                if (season.episodes && Array.isArray(season.episodes)) {
                                    season.episodes.forEach((ep, epIdx) => {
                                        addEpisode(lastSeason.querySelector('button[onclick^=addEpisode]'));
                                        const lastEp = lastSeason.querySelector('.episodes-list').lastElementChild;
                                        // Set the episode number in the block from ep.number if available
                                        const epNumInput = lastEp.querySelector('input.episode-number');
                                        if (epNumInput) {
                                            // Allow 0 and decimal numbers, but if ep.number is present use it, else double previous
                                            if (typeof ep.number !== "undefined" && ep.number !== null && ep.number !== '') {
                                                epNumInput.value = ep.number;
                                            } else if (epIdx > 0) {
                                                // Double the previous episode number
                                                const prevEp = lastSeason.querySelectorAll('.episodes-list .episode-block')[epIdx-1];
                                                const prevNumInput = prevEp.querySelector('input.episode-number');
                                                let prevNum = 1;
                                                if (prevNumInput && prevNumInput.value !== undefined && prevNumInput.value !== null && prevNumInput.value !== '') {
                                                    prevNum = Number(prevNumInput.value);
                                                    if (isNaN(prevNum)) prevNum = 1;
                                                }
                                                epNumInput.value = prevNum + 1;
                                            } else {
                                                epNumInput.value = 1;
                                            }
                                        }
                                        lastEp.querySelector('input[placeholder="Episode Title"]').value = ep.title || '';
                                        lastEp.querySelector('input[placeholder="Description"]').value = ep.description || '';
                                        lastEp.querySelector('input[placeholder="Image URL"]').value = ep.image || '';
                                        lastEp.querySelector('input[placeholder="Added Date"]').value = ep.addedDate || '';
                                        // Set episode rating if exists
                                        const ratingInput = lastEp.querySelector('.episode-rating-group input[placeholder="Rating"]');
                                        if (ratingInput) {
                                            ratingInput.value = (typeof ep.rating !== "undefined" && ep.rating !== null) ? ep.rating : '';
                                        }
                                        // Set the special checkbox if this episode is special
                                        const specialCheckbox = lastEp.querySelector('.special-episode-checkbox');
                                        if (specialCheckbox) {
                                            if (ep.special === true || (isSpecials && (typeof ep.special === "undefined" || ep.special === null))) {
                                                specialCheckbox.checked = true;
                                            } else {
                                                specialCheckbox.checked = false;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            } else {
                // Clear language, country, ageRating fields on add
                document.getElementById('language').value = '';
                document.getElementById('country').value = '';
                document.getElementById('ageRating').value = '';
            }
        }

        window.closeModal = function () {
            document.getElementById('itemModal').classList.remove('active');
        }

        async function saveItem(type, item, action = 'create') {
            try {
                const response = await fetch('http://127.0.0.1:5000/save_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, action, item })
                });

                if (!response.ok) throw new Error('Failed to save');

                const result = await response.json();
                if (result.error) throw new Error(result.error);

                // Show side notification instead of alert
                showSaveNotification(true, 'تم الحفظ بنجاح!');
                await fetchData(); // تحديث البيانات

            } catch (err) {
                showSaveNotification(false, 'حدث خطأ أثناء الحفظ: ' + err.message);
                console.error(err);
            }
        }
        document.getElementById('itemForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const type = document.getElementById('itemType').value;
            const id = document.getElementById('itemId').value;
            const yearInputValue = document.getElementById('year').value; // YYYY-MM-DD
            const releaseDate = yearInputValue ? yearInputValue.slice(0, 10) : '';
            const parsedYear = releaseDate ? parseInt(releaseDate.slice(0, 4), 10) : null;

            const item = {
                id: id ? Number(id) : Date.now(),
                title: document.getElementById('title').value,
                // genre كسلسلة مفصولة بفواصل من الاختيارات
                genre: document.getElementById('genre').value,
                year: parsedYear,
                releaseDate: releaseDate,
                rating: Number(document.getElementById('rating').value),
                duration: document.getElementById('duration').value,
                image: document.getElementById('image').value,
                backdrop: document.getElementById('backdrop').value,
                description: document.getElementById('description').value,
                language: document.getElementById('language').value,
                country: document.getElementById('country').value,
                ageRating: document.getElementById('ageRating').value
            };

            if (type === 'series') {
                item.status = document.getElementById('status').value;
                item.seasons = [];

                // Specials logic: collect specials episodes from all seasons, and remove them from their original season
                let specialsEpisodes = [];

                document.querySelectorAll('#seasonsList .season-block').forEach((seasonDiv, sIdx) => {
                    // جلب قيمة season_number من الحقل النصي مباشرة (حتى لو كانت نصية أو رقمية)
                    const seasonNumberInput = seasonDiv.querySelector('.season-number-input');
                    let seasonNumberValue = seasonNumberInput ? seasonNumberInput.value : (sIdx + 1);
                    // إذا كان فارغاً، استخدم رقم الموسم الافتراضي
                    if (seasonNumberValue === undefined || seasonNumberValue === null || seasonNumberValue === '') {
                        seasonNumberValue = sIdx + 1;
                    }
                    const season = { season_number: seasonNumberValue, episodes: [] };
                    seasonDiv.querySelectorAll('.episodes-list .episode-block').forEach((epDiv, epIdx) => {
                        const epNumInput = epDiv.querySelector('input.episode-number');
                        // عند الحفظ، رقم الحلقة يؤخذ من خانة number حتى لو كان صفر أو عدد عشري
                        let episodeNumber = null;
                        if (epNumInput && epNumInput.value !== undefined && epNumInput.value !== null && epNumInput.value !== '') {
                            episodeNumber = Number(epNumInput.value);
                        } else if (epIdx > 0) {
                            // Double the previous episode number
                            const prevEp = seasonDiv.querySelectorAll('.episodes-list .episode-block')[epIdx-1];
                            const prevNumInput = prevEp.querySelector('input.episode-number');
                            let prevNum = 1;
                            if (prevNumInput && prevNumInput.value !== undefined && prevNumInput.value !== null && prevNumInput.value !== '') {
                                prevNum = Number(prevNumInput.value);
                                if (isNaN(prevNum)) prevNum = 1;
                            }
                            episodeNumber = prevNum + 1;
                        } else {
                            episodeNumber = 1;
                        }
                        // Check if this episode is marked as special
                        const specialCheckbox = epDiv.querySelector('.special-episode-checkbox');
                        const isSpecial = specialCheckbox && specialCheckbox.checked;
                        const episodeObj = {
                            number: episodeNumber,
                            title: epDiv.querySelector('input[placeholder="Episode Title"]').value,
                            description: epDiv.querySelector('input[placeholder="Description"]').value,
                            image: epDiv.querySelector('input[placeholder="Image URL"]').value,
                            addedDate: epDiv.querySelector('input[placeholder="Added Date"]')?.value,
                            rating: epDiv.querySelector('.episode-rating-group input[placeholder="Rating"]')?.value,
                            special: isSpecial ? true : undefined
                        };
                        if (isSpecial) {
                            specialsEpisodes.push(episodeObj);
                        } else {
                            season.episodes.push(episodeObj);
                        }
                    });
                    // Only push season if it has non-special episodes
                    if (season.episodes.length > 0) {
                        item.seasons.push(season);
                    }
                });

                // Add specials as a separate "season"
                if (specialsEpisodes.length > 0) {
                    item.seasons.push({
                        season_number: 'specials',
                        name: 'Specials',
                        episodes: specialsEpisodes
                    });
                }
            }

            await saveItem(type, item, id ? 'update' : 'create');

            closeModal();
        });



        // Delete item
        window.deleteItem = async function (type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            let arr = (type === 'movie') ? data.movies : data.series;
            const idx = arr.findIndex(i => i.id === id);
            if (idx > -1) {
                arr.splice(idx, 1);
                try {
                    // إرسال حذف إلى خادم بايثون (Flask)
                    const response = await fetch('http://127.0.0.1:5000/save_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: type,
                            action: 'delete',
                            id: id
                        })
                    });
                    if (!response.ok) throw new Error('Network error');
                    await fetchData();
                    showSaveNotification(true, 'تم حذف العنصر بنجاح!');
                } catch (e) {
                    showSaveNotification(false, 'فشل في حذف العنصر!');
                    alert('فشل في حذف العنصر!');
                }
            }
        }

        // Show notification
        function showSaveNotification(success, msg) {
            const notif = document.getElementById('saveNotification');
            notif.textContent = msg || (success ? 'Changes saved successfully!' : 'Failed to save changes!');
            notif.style.background = success ? '#27ae60' : '#e74c3c';
            notif.style.opacity = '1';
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => { notif.style.display = 'none'; }, 400);
            }, 2200);
        }
    </script>
</body>

</html>