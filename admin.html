<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CineStream</title>
    <link rel="icon" type="image/png" href="CineStream web.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #12161f;
            font-family: 'Poppins', sans-serif;
            color: #f1f1f1;
            margin: 0;
            padding: 0;
        }

        .admin-container {
            max-width: 1100px;
            margin: 40px auto;
            background: #1c2130;
            border-radius: 18px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
            padding: 36px;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffd700;
        }

        .tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 26px;
            border: none;
            border-radius: 25px;
            background: #2a2f41;
            color: #fff;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s ease;
        }

        .tab-btn.active {
            background: #ffd700;
            color: #1c2130;
            font-weight: 600;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 32px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #2f3447;
            text-align: left;
        }

        .data-table th {
            background: #23283a;
            color: #ffd700;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #2a2f41;
        }

        .action-btn {
            background: #ffd700;
            color: #1c2130;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            margin-right: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s ease;
        }

        .action-btn.delete {
            background: #e74c3c;
            color: #fff;
        }

        .add-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 10px 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 18px;
            transition: 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1f2433;
            border-radius: 16px;
            padding: 40px 36px;
            /* Bigger padding */
            max-width: 5000px;
            width: 90%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 28px;
            color: #ffd700;
            font-size: 2.2rem;
            /* Bigger title */
        }

        .form-row {
            display: flex;
            gap: 32px;
            /* Bigger gap */
            margin-bottom: 28px;
            /* Bigger margin */
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            display: flex;
            margin-top: 20px;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.25rem;
            /* Bigger label */
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 18px 16px;
            /* Bigger input */
            border-radius: 14px;
            border: 1.5px solid #2e3347;
            background: #2a2f41;
            color: #fff;
            font-size: 1.25rem;
            /* Bigger font */
        }

        .form-group textarea {
            min-height: 140px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-top: 28px;
        }

        .modal-actions button {
            padding: 16px 36px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
        }

        .modal-actions .save-btn {
            background: #27ae60;
            color: #fff;
        }

        .modal-actions .cancel-btn {
            background: #e74c3c;
            color: #fff;
        }

        .data-table .img-cell {
            width: 80px;
            padding: 6px 4px;
        }

        .data-table .img-cell img {
            width: 120px;
            height: auto;
            object-fit: cover;
            border-radius: 8px;
            background: #181c24;
            border: 1px solid #2e3347;
            display: block;
        }

        /* Make season/episode blocks bigger in modal */
        .season-block {
            background: #23283a;
            padding: 18px 18px !important;
            margin-bottom: 18px !important;
            border-radius: 12px !important;
            font-size: 1.15rem;
        }

        .season-block strong {
            font-size: 1.2rem;
        }

        .season-block button {
            font-size: 1.1rem !important;
            padding: 6px 16px !important;
        }

        .episode-block {
            background: #2e3347;
            padding: 12px 12px !important;
            margin-bottom: 10px !important;
            border-radius: 10px !important;
            font-size: 1.1rem;
        }

        .episode-block input {
            font-size: 1.1rem !important;
            padding: 10px 10px !important;
            margin-right: 10px !important;
        }

        .episode-block button {
            font-size: 1.1rem !important;
            padding: 6px 16px !important;
        }

        /* Add style for episode rating input */
        .episode-block .episode-rating-group {
            display: flex;
            align-items: center;
            margin-top: 8px;
            margin-bottom: 8px;
            gap: 8px;
        }

        .episode-block .episode-rating-group label {
            font-size: 1.05rem;
            color: #ffd700;
            margin-bottom: 0;
            font-weight: 600;
        }

        .episode-block .episode-rating-group input[type="number"] {
            width: 80px;
            padding: 8px 10px !important;
            font-size: 1.1rem !important;
            border-radius: 8px;
            border: 1px solid #ffd700;
            background: #23283a;
            color: #fff;
        }

        /* Scrollbar Styles */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #2e3347;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1f2433;
        }

        @media (max-width: 700px) {
            .admin-container {
                padding: 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 16px;
                margin-bottom: 16px;
            }

            .data-table .img-cell {
                width: 40px;
            }

            .data-table .img-cell img {
                width: 40px;
                height: 60px;
            }

            .modal-content {
                padding: 16px 6px;
            }

            .modal-content h2 {
                font-size: 1.3rem;
            }

            .form-group label {
                font-size: 1rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 1rem;
                padding: 10px 8px;
            }

            .modal-actions button {
                font-size: 1rem;
                padding: 10px 18px;
            }

            .season-block,
            .episode-block {
                font-size: 1rem;
                padding: 8px 6px !important;
            }

            .episode-block .episode-rating-group input[type="number"] {
                width: 60px;
                font-size: 1rem !important;
            }
        }
    </style>

</head>

<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin Panel</h1>
        </div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="movies">Movies</button>
            <button class="tab-btn" data-tab="series">Series</button>
        </div>
        <div id="movies" class="section active">
            <button class="add-btn" onclick="openModal('movie')"><i class="fas fa-plus"></i> Add Movie</button>
            <table class="data-table" id="moviesTable">
                <thead>
                    <tr>
                        <th class="img-cell">Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Rating</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="series" class="section">
            <button class="add-btn" onclick="openModal('series')"><i class="fas fa-plus"></i> Add Series</button>
            <table class="data-table" id="seriesTable">
                <thead>
                    <tr>
                        <th class="img-cell">Image</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Status</th>
                        <th>Rating</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Item</h2>
            <form id="itemForm">
                <input type="hidden" id="itemType">
                <input type="hidden" id="itemId">
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn" id="saveBtn">Save</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label>Genre</label>
                        <div id="genreOptions" style="display:flex;flex-wrap:wrap;gap:8px;overflow:auto;border:1px solid rgba(255,255,255,0.12);padding:8px;border-radius:8px;"></div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                            <input type="text" id="genreCustomInput" placeholder="Add custom genre" style="flex:1;">
                            <button type="button" id="genreAddBtn" class="action-btn" style="padding:8px 14px;">Add</button>
                            <button type="button" id="genreClearBtn" class="action-btn delete" style="padding:8px 14px;">Clear</button>
                        </div>
                        <input type="hidden" id="genre">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="date" id="year" required>
                    </div>
                    <div class="form-group">
                        <label for="rating">Rating</label>
                        <input type="number" id="rating" step="0.1" min="0" max="10" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="duration">Duration</label>
                        <input type="text" id="duration" required>
                    </div>
                    <div class="form-group" id="statusGroup" style="display:none;">
                        <label for="status">Status</label>
                        <select id="status">
                            <option value="">Select status</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                <!-- New row for language, country, ageRating -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="language">Language</label>
                        <input type="text" id="language" placeholder="e.g. English, Arabic">
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" placeholder="e.g. USA, Egypt">
                    </div>
                    <div class="form-group">
                        <label for="ageRating">Age Rating</label>
                        <select id="ageRating">
                            <option value="">Select age rating</option>
                            <option value="G">G (General Audiences)</option>
                            <option value="PG">PG (Parental Guidance Suggested)</option>
                            <option value="PG-13">PG-13 (Parents Strongly Cautioned)</option>
                            <option value="R">R (Restricted)</option>
                            <option value="NC-17">NC-17 (Adults Only)</option>
                            <option value="TV-Y">TV-Y (All Children)</option>
                            <option value="TV-Y7">TV-Y7 (Directed to Older Children)</option>
                            <option value="TV-G">TV-G (General Audience)</option>
                            <option value="TV-PG">TV-PG (Parental Guidance Suggested)</option>
                            <option value="TV-14">TV-14 (Parents Strongly Cautioned)</option>
                            <option value="TV-MA">TV-MA (Mature Audience Only)</option>
                        </select>
                    </div>
                </div>
                <div id="editForm"></div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="image">Image URL</label>
                        <input type="url" id="image" required>
                    </div>
                    <div class="form-group">
                        <label for="backdrop">Backdrop URL</label>
                        <input type="url" id="backdrop" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="form-group" id="seasonsGroup" style="display:none;">
                    <label>Seasons & Episodes</label>
                    <div id="seasonsList"></div>
                    <button type="button" class="add-btn"
                        style="margin:16px 0 0 0; padding:12px 28px; font-size:1.15rem;" onclick="addSeason()"><i
                            class="fas fa-plus"></i> Add Season</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="save-btn" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="saveNotification"
        style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);z-index:2000;padding:16px 32px;background:#23283a;color:#fff;border-radius:10px;font-weight:600;box-shadow:0 2px 12px rgba(0,0,0,0.18);font-size:1.1rem;transition:opacity 0.3s;opacity:0;">
    </div>
    <script type="module">
        async function loadForm(type, item) {
            const res = await fetch("/static/fields_config.json"); // تأكد أن الملف هنا أو غير المسار
            const config = await res.json();

            const container = document.getElementById("editForm");
            container.innerHTML = "";

            const fields = config[type];
            fields.forEach(field => {
                const value = item[field] || "";
                const input = document.createElement("input");
                input.name = field;
                input.value = value;
                input.placeholder = field;
                container.appendChild(input);
                container.appendChild(document.createElement("br"));
            });
        }

        let data = { movies: [], series: [] };

        // Fetch data from data.json
        async function fetchData() {
            try {
                const res = await fetch('data.json');
                data = await res.json();
                renderTables();
                populateGenreOptions();
            } catch (e) {
                showSaveNotification(false, 'فشل في تحميل البيانات!');
            }
        }
        fetchData();

        // Render tables
        function renderTables() {
            // Movies
            const moviesTbody = document.querySelector('#moviesTable tbody');
            moviesTbody.innerHTML = '';
            data.movies.forEach(movie => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="img-cell">
                        <img src="${movie.image ? movie.image : ''}" alt="Movie Image" onerror="this.onerror=null; this.src='13434998.png';";">
                    </td>
                    <td>${movie.title}</td>
                    <td>${movie.genre}</td>
                    <td>${movie.year ? (typeof movie.year === 'string' ? movie.year.slice(0,4) : movie.year) : ''}</td>
                    <td>${movie.rating}</td>
                    <td>${movie.duration}</td>
                    <td>
                        <button class="action-btn" style="font-size:1.15rem;padding:12px 28px;" onclick="openModal('movie', ${movie.id})">Edit</button>
                        <button class="action-btn delete" style="font-size:1.15rem;padding:12px 28px;" onclick="deleteItem('movie', ${movie.id})">Delete</button>
                    </td>
                `;
                moviesTbody.appendChild(tr);
            });
            // Series
            const seriesTbody = document.querySelector('#seriesTable tbody');
            seriesTbody.innerHTML = '';
            data.series.forEach(series => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="img-cell">
                        <img src="${series.image ? series.image : ''}" alt="Series Image" onerror="this.onerror=null; this.src='13434998.png';";">
                    </td>
                    <td>${series.title}</td>
                    <td>${series.genre}</td>
                    <td>${series.year ? (typeof series.year === 'string' ? series.year.slice(0,4) : series.year) : ''}</td>
                    <td>${series.status || ''}</td>
                    <td>${series.rating}</td>
                    <td>${series.duration}</td>
                    <td>
                        <button class="action-btn" style="font-size:1.15rem;padding:12px 28px;" onclick="openModal('series', ${series.id})">Edit</button>
                        <button class="action-btn delete" style="font-size:1.15rem;padding:12px 28px;" onclick="deleteItem('series', ${series.id})">Delete</button>
                    </td>
                `;
                seriesTbody.appendChild(tr);
            });
        }

        function uniqGenresFromData() {
            const set = new Set();
            const add = (g) => {
                if (!g) return;
                if (Array.isArray(g)) g.forEach(x => String(x).split(',').forEach(y => set.add(y.trim())));
                else String(g).split(',').forEach(y => set.add(y.trim()));
            };
            (data.movies || []).forEach(m => add(m.genre));
            (data.series || []).forEach(s => add(s.genre));
            return Array.from(set).filter(x => x).sort((a,b) => a.localeCompare(b));
        }

        function populateGenreOptions() {
            const container = document.getElementById('genreOptions');
            if (!container) return;
            container.innerHTML = '';
            const genres = uniqGenresFromData();
            genres.forEach(g => {
                const label = document.createElement('label');
                label.style = 'display:inline-flex;align-items:center;gap:6px;background:#2e3347;padding:6px 10px;border-radius:6px;cursor:pointer;';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = g;
                cb.addEventListener('change', () => {
                    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                    document.getElementById('genre').value = selected.join(', ');
                });
                const span = document.createElement('span');
                span.textContent = g;
                label.appendChild(cb);
                label.appendChild(span);
                container.appendChild(label);
            });

            // Wire the custom add button
            const addBtn = document.getElementById('genreAddBtn');
            const input = document.getElementById('genreCustomInput');
            if (addBtn && input) {
                const addCustom = () => {
                    const val = (input.value || '').trim();
                    if (!val) return;
                    // Prevent duplicates (case-insensitive)
                    const exists = Array.from(container.querySelectorAll('input[type="checkbox"]')).some(cb => cb.value.toLowerCase() === val.toLowerCase());
                    if (!exists) {
                        const label = document.createElement('label');
                        label.style = 'display:inline-flex;align-items:center;gap:6px;background:#2e3347;padding:6px 10px;border-radius:6px;cursor:pointer;';
                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.value = val;
                        cb.checked = true;
                        cb.addEventListener('change', () => {
                            const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                            document.getElementById('genre').value = selected.join(', ');
                        });
                        const span = document.createElement('span');
                        span.textContent = val;
                        label.appendChild(cb);
                        label.appendChild(span);
                        container.appendChild(label);
                    } else {
                        // If exists, just check it
                        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb.value.toLowerCase() === val.toLowerCase()) cb.checked = true;
                        });
                    }
                    // Update hidden field and clear input
                    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
                    document.getElementById('genre').value = selected.join(', ');
                    input.value = '';
                    input.focus();
                };
                addBtn.onclick = addCustom;
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustom();
                    }
                });
            }

            // Wire clear button
            const clearBtn = document.getElementById('genreClearBtn');
            if (clearBtn) {
                clearBtn.onclick = () => {
                    container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.getElementById('genre').value = '';
                };
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(type + '-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }


        // Tabs logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Show/hide seasons field for series
        function toggleSeasonsField(type) {
            document.getElementById('seasonsGroup').style.display = (type === 'series') ? 'block' : 'none';
        }

        // Add season
        window.addSeason = function () {
            const seasonsList = document.getElementById('seasonsList');
            const seasonIdx = seasonsList.children.length + 1;
            const seasonDiv = document.createElement('div');
            seasonDiv.className = 'season-block';
            seasonDiv.style = 'background:#23283a;padding:18px 18px;margin-bottom:18px;border-radius:12px;';
            seasonDiv.innerHTML = `
                <strong>Season ${seasonIdx}</strong> <button type="button" onclick="this.parentElement.remove()" style="float:right;background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Delete</button>
                <div style="margin-top:12px;">
                    <label style="font-size:1.1rem;">Episodes:</label>
                    <div class="episodes-list"></div>
                    <button type="button" onclick="addEpisode(this)" style="margin-top:10px;background:#27ae60;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Add Episode</button>
                </div>
            `;
            seasonsList.appendChild(seasonDiv);
        }

        // Add episode
        window.addEpisode = function (btn) {
            const episodesList = btn.parentElement.querySelector('.episodes-list');
            const epIdx = episodesList.children.length + 1;
            const epDiv = document.createElement('div');
            epDiv.className = 'episode-block';
            epDiv.style = 'background:#2e3347;padding:12px 12px;margin-bottom:10px;border-radius:10px;';
            // Add the episode number at the top of the episode block
            epDiv.innerHTML = `
                <div style="font-weight:bold;margin-bottom:8px;">${epIdx}</div>
                <input type="text" placeholder="Episode Title" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="text" placeholder="Description" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="url" placeholder="Image URL" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <input type="date" placeholder="Added Date" style="margin-right:10px;font-size:1.1rem;padding:10px 10px;">
                <div class="episode-rating-group">
                    <label>Rating</label>
                    <input type="number" placeholder="Rating" min="0" max="10" step="0.1" style="margin-right:10px;">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:6px 16px;font-size:1.1rem;">Delete</button>
            `;
            episodesList.appendChild(epDiv);
        }

        // Override openModal to load seasons/episodes
        window.openModal = function (type, id = null) {
            document.getElementById('itemModal').classList.add('active');
            document.getElementById('itemForm').reset();
            document.getElementById('itemType').value = type;
            document.getElementById('itemId').value = id || '';
            document.getElementById('modalTitle').textContent = id ? 'Edit ' + (type === 'movie' ? 'Movie' : 'Series') : 'Add ' + (type === 'movie' ? 'Movie' : 'Series');
            document.getElementById('statusGroup').style.display = (type === 'series') ? 'block' : 'none';
            toggleSeasonsField(type);
            // Clear seasons
            document.getElementById('seasonsList').innerHTML = '';
            // Fill language, country, ageRating if editing
            if (id) {
                const item = (type === 'movie' ? data.movies : data.series).find(i => i.id === id);
                if (item) {
                    document.getElementById('title').value = item.title;
                    // اضبط خيارات الأنواع المحددة
                    (function(){
                        const container = document.getElementById('genreOptions');
                        const selected = Array.isArray(item.genre) ? item.genre : String(item.genre || '').split(',').map(x=>x.trim()).filter(Boolean);
                        // تأكد أن الخيارات موجودة، ثم علم المختار
                        populateGenreOptions();
                        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            cb.checked = selected.includes(cb.value);
                        });
                        document.getElementById('genre').value = selected.join(', ');
                    })();
                    // اضبط حقل التاريخ مفضلاً releaseDate إن وجد، وإلا فحوّل السنة إلى YYYY-01-01
                    (function(){
                        const dateInput = document.getElementById('year');
                        if (!dateInput) return;
                        const raw = item.releaseDate || item.year;
                        if (!raw) { dateInput.value = ''; return; }
                        const s = String(raw).trim();
                        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                            dateInput.value = s.slice(0,10);
                        } else if (/^\d{4}/.test(s)) {
                            dateInput.value = `${s.slice(0,4)}-01-01`;
                        } else {
                            dateInput.value = '';
                        }
                    })();
                    document.getElementById('rating').value = item.rating;
                    document.getElementById('duration').value = item.duration;
                    document.getElementById('image').value = item.image;
                    document.getElementById('backdrop').value = item.backdrop;
                    document.getElementById('description').value = item.description;
                    document.getElementById('language').value = item.language || '';
                    document.getElementById('country').value = item.country || '';
                    document.getElementById('ageRating').value = item.ageRating || '';
                    if (type === 'series') {
                        document.getElementById('status').value = item.status || '';
                        // Load seasons/episodes
                        if (item.seasons && Array.isArray(item.seasons)) {
                            item.seasons.forEach(season => {
                                addSeason();
                                const lastSeason = document.getElementById('seasonsList').lastElementChild;
                                if (season.episodes && Array.isArray(season.episodes)) {
                                    season.episodes.forEach((ep, epIdx) => {
                                        addEpisode(lastSeason.querySelector('button[onclick^=addEpisode]'));
                                        const lastEp = lastSeason.querySelector('.episodes-list').lastElementChild;
                                        // Set the episode number in the block
                                        if (lastEp && lastEp.firstElementChild && lastEp.firstElementChild.tagName === "DIV") {
                                            lastEp.firstElementChild.textContent = (epIdx + 1);
                                        }
                                        lastEp.querySelector('input[placeholder="Episode Title"]').value = ep.title || '';
                                        lastEp.querySelector('input[placeholder="Description"]').value = ep.description || '';
                                        lastEp.querySelector('input[placeholder="Image URL"]').value = ep.image || '';
                                        lastEp.querySelector('input[placeholder="Added Date"]').value = ep.addedDate || '';
                                        // Set episode rating if exists
                                        const ratingInput = lastEp.querySelector('.episode-rating-group input[placeholder="Rating"]');
                                        if (ratingInput) {
                                            ratingInput.value = (typeof ep.rating !== "undefined" && ep.rating !== null) ? ep.rating : '';
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            } else {
                // Clear language, country, ageRating fields on add
                document.getElementById('language').value = '';
                document.getElementById('country').value = '';
                document.getElementById('ageRating').value = '';
            }
        }

        window.closeModal = function () {
            document.getElementById('itemModal').classList.remove('active');
        }

        async function saveItem(type, item, action = 'create') {
            try {
                const response = await fetch('http://127.0.0.1:5000/save_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, action, item })
                });

                if (!response.ok) throw new Error('Failed to save');

                const result = await response.json();
                if (result.error) throw new Error(result.error);

                // Show side notification instead of alert
                showSaveNotification(true, 'تم الحفظ بنجاح!');
                await fetchData(); // تحديث البيانات

            } catch (err) {
                showSaveNotification(false, 'حدث خطأ أثناء الحفظ: ' + err.message);
                console.error(err);
            }
        }
        document.getElementById('itemForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const type = document.getElementById('itemType').value;
            const id = document.getElementById('itemId').value;
            const yearInputValue = document.getElementById('year').value; // YYYY-MM-DD
            const releaseDate = yearInputValue ? yearInputValue.slice(0, 10) : '';
            const parsedYear = releaseDate ? parseInt(releaseDate.slice(0, 4), 10) : null;

            const item = {
                id: id ? Number(id) : Date.now(),
                title: document.getElementById('title').value,
                // genre كسلسلة مفصولة بفواصل من الاختيارات
                genre: document.getElementById('genre').value,
                year: parsedYear,
                releaseDate: releaseDate,
                rating: Number(document.getElementById('rating').value),
                duration: document.getElementById('duration').value,
                image: document.getElementById('image').value,
                backdrop: document.getElementById('backdrop').value,
                description: document.getElementById('description').value,
                language: document.getElementById('language').value,
                country: document.getElementById('country').value,
                ageRating: document.getElementById('ageRating').value
            };

            if (type === 'series') {
                item.status = document.getElementById('status').value;
                item.seasons = [];
                document.querySelectorAll('#seasonsList .season-block').forEach((seasonDiv, sIdx) => {
                    const season = { season_number: sIdx + 1, episodes: [] };
                    seasonDiv.querySelectorAll('.episodes-list .episode-block').forEach((epDiv, epIdx) => {
                        // Ensure episode number is updated in the block (in case of reordering in the future)
                        if (epDiv.firstElementChild && epDiv.firstElementChild.tagName === "DIV") {
                            epDiv.firstElementChild.textContent = (epIdx + 1);
                        }
                        season.episodes.push({
                            title: epDiv.querySelector('input[placeholder="Episode Title"]').value,
                            description: epDiv.querySelector('input[placeholder="Description"]').value,
                            image: epDiv.querySelector('input[placeholder="Image URL"]').value,
                            addedDate: epDiv.querySelector('input[placeholder="Added Date"]')?.value,
                            rating: epDiv.querySelector('.episode-rating-group input[placeholder="Rating"]')?.value
                        });
                    });
                    item.seasons.push(season);
                });
            }

            await saveItem(type, item, id ? 'update' : 'create');

            closeModal();
        });



        // Delete item
        window.deleteItem = async function (type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            let arr = (type === 'movie') ? data.movies : data.series;
            const idx = arr.findIndex(i => i.id === id);
            if (idx > -1) {
                arr.splice(idx, 1);
                try {
                    // إرسال حذف إلى خادم بايثون (Flask)
                    const response = await fetch('http://127.0.0.1:5000/save_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: type,
                            action: 'delete',
                            id: id
                        })
                    });
                    if (!response.ok) throw new Error('Network error');
                    await fetchData();
                    showSaveNotification(true, 'تم حذف العنصر بنجاح!');
                } catch (e) {
                    showSaveNotification(false, 'فشل في حذف العنصر!');
                    alert('فشل في حذف العنصر!');
                }
            }
        }

        // Show notification
        function showSaveNotification(success, msg) {
            const notif = document.getElementById('saveNotification');
            notif.textContent = msg || (success ? 'Changes saved successfully!' : 'Failed to save changes!');
            notif.style.background = success ? '#27ae60' : '#e74c3c';
            notif.style.opacity = '1';
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => { notif.style.display = 'none'; }, 400);
            }, 2200);
        }
    </script>
</body>

</html>