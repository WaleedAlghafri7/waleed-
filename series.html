<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Content - CineStream</title>
    <link rel="icon" type="image/png" href="CineStream web.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="search">
                <div class="search-icon">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <div class="search-input-container">
                    <input type="text" placeholder="Search for movies or series...">
                </div>
            </div>
            <div class="name-wab">
                <p>CineStream</p>
            </div>
            <div class="user-list">
                <div class="list-siting">
                    <button class="list-siting-button">
                        <i class="fa-solid fa-bars"></i>
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <div class="list-siting-item">
                        <button onclick="window.location.href='index.html'" class="active">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button onclick="window.location.href='movies.html'">
                            <i class="fas fa-film"></i>
                            Movies
                        </button>
                        <button onclick="window.location.href='series.html'">
                            <i class="fas fa-tv"></i>
                            Series
                        </button>
                        <button onclick="window.location.href='all-content.html'">
                            <i class="fas fa-th-large"></i>
                            All Content
                        </button>
                    </div>
                </div>
                <!-- Auth Buttons -->
                
                <div class="user-icon">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="user-dropdown">
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="user-details">
                            <h4 id="user-name">User Name</h4>
                            <p id="user-email">user@email.com</p>
                        </div>
                    </div>
                    <div class="user-menu">
                        <button onclick="window.location.href='profile.html'">
                            <i class="fa-solid fa-user-gear"></i>
                            Profile Settings
                        </button>
                        <button onclick="window.location.href='notifications.html'">
                            <i class="fa-solid fa-bell"></i>
                            Notifications
                        </button>
                        <button onclick="window.location.href='settings.html'">
                            <i class="fa-solid fa-gear"></i>
                            Settings
                        </button>
                        <button class="logout-btn">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="all-content">
                <div class="section-header">
                    <h2>All Series</h2>
                    <div class="filter-options">
                        <button class="filter-btn active" data-filter="all" style="display:none;">All</button>
                        <button class="filter-btn" data-filter="movies" style="display:none;">Movies</button>
                        <button class="filter-btn" data-filter="series" style="display:none;">Series</button>
                        <select class="genre-select">
                            <option value="all">All Genres</option>
                        </select>
                        <select class="sort-select">
                            <option value="latest">Latest</option>
                            <option value="rating">Rating</option>
                            <option value="popularity">Popularity</option>
                            <option value="oldest">Oldest</option>
                            <option value="az">A-Z</option>
                            <option value="za">Z-A</option>
                        </select>
                    </div>
                </div>
                <div class="content-grid">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
        <div id="footer-container"></div>
        <button class="back-arrow" onclick="history.back()" aria-label="رجوع">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    <script>
        // ==== إدارة تسجيل الدخول ====
        function getCurrentUser() {
            try {
                const userStr = localStorage.getItem('auth_user');
                if (!userStr) return null;
                return JSON.parse(userStr);
            } catch (e) {
                return null;
            }
        }
    
        function isAuthenticated() {
            return !!localStorage.getItem('auth_token');
        }
    
        function updateAuthUI() {
            const user = getCurrentUser();
            const isLoggedIn = isAuthenticated();
    
            const userNameEl = document.getElementById('user-name');
            const userEmailEl = document.getElementById('user-email');
            const authButtons = document.querySelector('.auth-buttons');
            const logoutBtn = document.querySelector('.logout-btn');
    
            if (isLoggedIn && user) {
                if (userNameEl) userNameEl.textContent = user.fullName || 'User';
                if (userEmailEl) userEmailEl.textContent = user.email || '';
                if (authButtons) authButtons.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
            } else {
                if (userNameEl) userNameEl.textContent = 'User Name';
                if (userEmailEl) userEmailEl.textContent = 'user@email.com';
                if (authButtons) authButtons.style.display = 'flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
    
            if (logoutBtn) {
                logoutBtn.onclick = function() {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('auth_user');
                    updateAuthUI();
                    window.location.href = 'index.html';
                };
            }
        }
    
        document.addEventListener('DOMContentLoaded', updateAuthUI);
        // تهيئة البحث
        function initializeSearch() {
            const searchIcon = document.querySelector('.search-icon');
            const searchInput = document.querySelector('.search input');
            const searchContainer = document.querySelector('.search-input-container');

            searchIcon.addEventListener('click', () => {
                searchIcon.classList.toggle('active');
                searchInput.classList.toggle('active');
                if (searchInput.classList.contains('active')) {
                    searchInput.focus();
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchQuery = searchInput.value.trim();
                    if (searchQuery) {
                        window.location.href = `search.html?q=${encodeURIComponent(searchQuery)}`;
                    }
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchContainer.contains(e.target) && !searchIcon.contains(e.target)) {
                    searchIcon.classList.remove('active');
                    searchInput.classList.remove('active');
                }
            });
        }

        // تهيئة قائمة المستخدم
        function initializeUserMenu() {
            const userIcon = document.querySelector('.user-icon');
            const userDropdown = document.querySelector('.user-dropdown');
            const menuButton = document.querySelector('.list-siting-button');
            const menuItems = document.querySelector('.list-siting-item');

            userIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
                menuItems.classList.remove('active');
                menuButton.classList.remove('active');
            });

            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                menuItems.classList.toggle('active');
                menuButton.classList.toggle('active');
                userDropdown.classList.remove('active');
            });

            userDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            menuItems.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            document.addEventListener('click', () => {
                userDropdown.classList.remove('active');
                menuItems.classList.remove('active');
                menuButton.classList.remove('active');
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    userDropdown.classList.remove('active');
                    menuItems.classList.remove('active');
                    menuButton.classList.remove('active');
                }
            });
        }

        // استخراج جميع الأنواع من البيانات
        function extractGenres(data) {
            const genresSet = new Set();
            const addGenres = (arr) => {
                arr.forEach(item => {
                    if (item.genre) {
                        if (Array.isArray(item.genre)) {
                            item.genre.forEach(g => genresSet.add(g.trim()));
                        } else if (typeof item.genre === 'string') {
                            item.genre.split(',').forEach(g => genresSet.add(g.trim()));
                        }
                    }
                });
            };
            addGenres(data.movies || []);
            addGenres(data.series || []);
            return Array.from(genresSet).filter(g => g && g.toLowerCase() !== 'unknown').sort();
        }

        // تحميل وعرض المحتوى
        let globalData = null;
        let genresPopulated = false;

        async function loadContent() {
            try {
                if (!globalData) {
                    const response = await fetch('data.json');
                    globalData = await response.json();
                }
                const data = globalData;
                let allContent = [...data.series];

                // Apply incoming genre filter from URL if present
                const params = new URLSearchParams(window.location.search);
                const initialGenre = params.get('genre');

                // Populate genres dropdown once
                if (!genresPopulated) {
                    const genres = extractGenres(data);
                    const genreSelect = document.querySelector('.genre-select');
                    genres.forEach(genre => {
                        const opt = document.createElement('option');
                        opt.value = genre;
                        opt.textContent = genre;
                        genreSelect.appendChild(opt);
                    });
                    genresPopulated = true;
                    if (initialGenre) {
                        genreSelect.value = initialGenre;
                    }
                }

                // تطبيق الفلتر النشط (Movies/Series)
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                if (activeFilter !== 'all') {
                    allContent = allContent.filter(item => 
                        activeFilter === 'movies' ? !item.seasons : item.seasons
                    );
                }

                // فلترة حسب النوع
                const genreValue = document.querySelector('.genre-select').value;
                if (genreValue && genreValue !== 'all') {
                    allContent = allContent.filter(item => {
                        if (!item.genre) return false;
                        if (Array.isArray(item.genre)) {
                            return item.genre.map(g => g.trim().toLowerCase()).includes(genreValue.toLowerCase());
                        } else if (typeof item.genre === 'string') {
                            return item.genre.split(',').map(g => g.trim().toLowerCase()).includes(genreValue.toLowerCase());
                        }
                        return false;
                    });
                }

                // تطبيق الترتيب (تم التعديل هنا)
                const sortValue = document.querySelector('.sort-select').value;
                switch (sortValue) {
                    case 'rating':
                        allContent.sort((a, b) => {
                            const ra = typeof a.rating === 'number' ? a.rating : parseFloat(a.rating) || 0;
                            const rb = typeof b.rating === 'number' ? b.rating : parseFloat(b.rating) || 0;
                            return rb - ra;
                        });
                        break;
                    case 'popularity':
                        allContent.sort((a, b) => {
                            const pa = typeof a.popularity === 'number' ? a.popularity : parseFloat(a.popularity) || 0;
                            const pb = typeof b.popularity === 'number' ? b.popularity : parseFloat(b.popularity) || 0;
                            return pb - pa;
                        });
                        break;
                    case 'oldest':
                        allContent.sort((a, b) => {
                            const getFullDate = (item) => {
                                // أولوية للتاريخ الكامل (releaseDate)
                                if (item.releaseDate) {
                                    const date = new Date(item.releaseDate);
                                    if (!isNaN(date.getTime())) return date;
                                }
                                
                                // إذا لم يكن هناك تاريخ كامل، استخدم السنة
                                if (item.year) {
                                    const year = typeof item.year === 'string' ? parseInt(item.year.slice(0, 4), 10) : item.year;
                                    if (!isNaN(year)) return new Date(year, 0, 1);
                                }
                                
                                // إذا لم يكن هناك تاريخ، استخدم تاريخ الإضافة
                                if (item.addedDate) {
                                    const date = new Date(item.addedDate);
                                    if (!isNaN(date.getTime())) return date;
                                }
                                
                                // إذا لم يكن هناك أي تاريخ، استخدم تاريخ قديم جداً
                                return new Date(0);
                            };
                            return getFullDate(a) - getFullDate(b);
                        });
                        break;
                    case 'az':
                        allContent.sort((a, b) => {
                            const ta = (a.title || '').toLowerCase();
                            const tb = (b.title || '').toLowerCase();
                            if (ta < tb) return -1;
                            if (ta > tb) return 1;
                            return 0;
                        });
                        break;
                    case 'za':
                        allContent.sort((a, b) => {
                            const ta = (a.title || '').toLowerCase();
                            const tb = (b.title || '').toLowerCase();
                            if (ta > tb) return -1;
                            if (ta < tb) return 1;
                            return 0;
                        });
                        break;
                    default: // latest
                        allContent.sort((a, b) => {
                            const getFullDate = (item) => {
                                // أولوية للتاريخ الكامل (releaseDate)
                                if (item.releaseDate) {
                                    const date = new Date(item.releaseDate);
                                    if (!isNaN(date.getTime())) return date;
                                }
                                
                                // إذا لم يكن هناك تاريخ كامل، استخدم السنة
                                if (item.year) {
                                    const year = typeof item.year === 'string' ? parseInt(item.year.slice(0, 4), 10) : item.year;
                                    if (!isNaN(year)) return new Date(year, 0, 1);
                                }
                                
                                // إذا لم يكن هناك تاريخ، استخدم تاريخ الإضافة
                                if (item.addedDate) {
                                    const date = new Date(item.addedDate);
                                    if (!isNaN(date.getTime())) return date;
                                }
                                
                                // إذا لم يكن هناك أي تاريخ، استخدم تاريخ قديم جداً
                                return new Date(0);
                            };
                            return getFullDate(b) - getFullDate(a);
                        });
                }

                displayContent(allContent);
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }

        function displayContent(content) {
            const contentGrid = document.querySelector('.content-grid');
            contentGrid.innerHTML = '';

            if (content.length === 0) {
                contentGrid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-film" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>No content found</p>
                        <p style="color: rgba(255, 255, 255, 0.5); margin-top: 10px;">Try different filters</p>
                    </div>`;
                return;
            }

            content.forEach(item => {
                const card = document.createElement('div');
                card.className = item.seasons ? 'series-card' : 'movie-card';
                card.onclick = () => window.location.href = `content.html?id=${item.id}&type=${item.seasons ? 'series' : 'movie'}`;
                
                card.innerHTML = `
                    ${item.seasons ? `
                        <div class="status-indicator ${item.status}">
                            <i class="fas ${item.status === 'ongoing' ? 'fa-play-circle' : 'fa-check-circle'}"></i>
                        </div>
                    ` : ''}
                    <img src="${item.image}" alt="${item.title}"  onerror="this.onerror=null; this.src='13434998.png';">
                    <div class="series-info">
                        <h3>${item.title}</h3>
                        <div class="movie-details">
                            <div class="rating">
                                <i class="fas fa-star"></i>
                                <span>${item.rating}</span>
                            </div>
                            <div class="year">
                                <span>${item.year ? (typeof item.year === 'string' ? item.year.slice(0,4) : item.year) : ''}</span>
                            </div>
                        </div>
                    </div>
                `;

                contentGrid.appendChild(card);

                // Genre chip click: pre-filter this page by the clicked genre
                card.querySelectorAll('.genre-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const g = chip.dataset.genre;
                        const url = new URL(window.location.href);
                        url.searchParams.set('genre', g);
                        history.replaceState(null, '', url.toString());
                        document.querySelector('.genre-select').value = g;
                        loadContent();
                    });
                });
            });
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            initializeSearch();
            initializeUserMenu();
            loadContent();

            // إضافة مستمعي الأحداث للفلترة والترتيب
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    loadContent();
                });
            });

            const sortSelect = document.querySelector('.sort-select');
            sortSelect.addEventListener('change', loadContent);

            const genreSelect = document.querySelector('.genre-select');
            genreSelect.addEventListener('change', loadContent);
            // Load header and footer
        fetch('header.html')
            .then(res => res.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            });

        fetch('footer.html')
            .then(res => res.text())
            .then(data => {
                document.getElementById('footer-container').innerHTML = data;
            });

        // Load content when page loads
        document.addEventListener('DOMContentLoaded', loadContent);
        });
    </script>
</body>
</html> 